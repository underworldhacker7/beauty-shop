<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders | G&G Beauty</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="order.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

    <div class="order-container">
        <header>
            <h1>My Account</h1>
            <p>Review your selection and order history</p>
        </header>

        <div class="order-grid">
            <main>
                <section class="card">
                    <h3>Current Order</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="cart-items-body"></tbody>
                    </table>
                    <div style="text-align: right; margin-top: 20px;">
                        <span style="color: var(--text-muted); margin-right: 15px;">Subtotal</span>
                        <strong style="font-size: 1.4rem;">$<span id="cart-grand-total">0.00</span></strong>
                    </div>
                </section>

                <section class="card">
                    <h3>Order History</h3>
                    <div id="order-history-list">
                        <p style="color: var(--text-muted);">No past orders found.</p>
                    </div>
                </section>
            </main>

            <aside>
                <section class="card">
                    <h3>Customer Profile</h3>
                    <div id="user-details">
                        <p>Authenticating...</p>
                    </div>
                </section>

                <section class="card">
                    <h3>Checkout</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
                        Standard shipping and taxes calculated at next step.
                    </p>
                    <button class="btn-primary" id="place-order-btn">PLACE ORDER NOW</button>
                </aside>
            </aside>
        </div>
    </div>

    <script>
        const firebaseConfig = { /* Paste Your Config Here */ };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        const API_URL = 'http://localhost:3307/api';
        const CART_KEY = 'cart'; 

        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                const snapshot = await firebase.database().ref('users/' + user.uid).once('value');
                const profile = snapshot.val();
                document.getElementById('user-details').innerHTML = `
                    <p><strong>Name</strong> ${profile?.name || user.displayName || 'Guest'}</p>
                    <p><strong>Email</strong> ${user.email}</p>
                    <p><strong>Address</strong> ${profile?.address || 'Not set'}</p>
                `;
                loadOrderHistory();
            } else {
                window.location.href = 'login.html';
            }
        });

        function renderCart() {
            const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            const tbody = document.getElementById('cart-items-body');
            let total = 0;

            if (cart.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">Your cart is empty</td></tr>';
                document.getElementById('cart-grand-total').textContent = '0.00';
                return;
            }

            tbody.innerHTML = cart.map(item => {
                const lineTotal = item.price * (item.qty || item.quantity || 1);
                total += lineTotal;
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.qty || item.quantity}</td>
                        <td>$${item.price}</td>
                        <td>$${lineTotal.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            document.getElementById('cart-grand-total').textContent = total.toFixed(2);
        }

        document.getElementById('place-order-btn').onclick = async function() {
            const token = localStorage.getItem('token');
            const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];

            if (!token) return alert('Login required');
            if (cart.length === 0) return alert('Cart empty');
            
            try {
                const res = await fetch(`${API_URL}/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ cart })
                });

                if (res.ok) {
                    alert('Success! Order confirmed.');
                    localStorage.removeItem(CART_KEY);
                    renderCart();
                    loadOrderHistory();
                } else {
                    const err = await res.json();
                    alert(err.message);
                }
            } catch (e) {
                alert('Connection error');
            }
        };

        async function loadOrderHistory() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch(`${API_URL}/orders`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const orders = await res.json();
                const container = document.getElementById('order-history-list');

                if (orders.length > 0) {
                    container.innerHTML = orders.map(o => `
                        <div class="history-item">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>Order #${o.id || 'N/A'}</strong>
                                <span class="status-badge">Processing</span>
                            </div>
                            <p style="margin: 5px 0; font-size: 0.8rem; color: var(--text-muted);">
                                ${new Date(o.date).toLocaleDateString()}
                            </p>
                            <p>Total <span style="color:var(--gold)">$${o.total}</span></p>
                        </div>
                    `).join('');
                }
            } catch (err) {}
        }

        document.addEventListener('DOMContentLoaded', renderCart);
    </script>
</body>
</html>
